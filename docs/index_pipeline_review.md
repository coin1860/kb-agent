# KB-Agent Index Pipeline æ·±åº¦å®¡æŸ¥æŠ¥å‘Š

## ðŸ“Š å®¡æŸ¥æ€»ç»“

æœ¬æ¬¡å®¡æŸ¥è¦†ç›–äº† indexing pipeline çš„å®Œæ•´é“¾è·¯ï¼Œä»Žæ–‡ä»¶è¯»å– (Connector) åˆ°å†…å®¹åŠ å·¥ (Processor)ï¼Œå†åˆ°å‘é‡å­˜å‚¨ (VectorTool) å’Œæ‘˜è¦ç”Ÿæˆ (LLMClient)ã€‚

**æ ¸å¿ƒç»“è®ºï¼š** å½“å‰ç³»ç»Ÿå¤„äºŽ MVPï¼ˆæœ€å°å¯ç”¨ï¼‰é˜¶æ®µï¼Œä½†åœ¨å¤„ç†**å¤§æ–‡ä»¶**ã€**å¤æ‚æ ¼å¼ï¼ˆWord/Excelï¼‰**ä»¥åŠ**æ£€ç´¢æ·±åº¦**ä¸Šå­˜åœ¨ä¸¥é‡çš„æž¶æž„æ€§ç¼ºé™·ï¼Œå¯¼è‡´å¤§é‡çŸ¥è¯†ä¸¢å¤±ã€‚

---

## 1. å…³é”®é—®é¢˜æ·±åº¦åˆ†æž

### ðŸ”´ é—®é¢˜ 1: Word æ–‡æ¡£å†…å®¹ä¸¥é‡ä¸¢å¤± (æ–°å‘çŽ°)
> [!CAUTION]
> ç”¨æˆ·æŠ¥å‘Š 5MB Word æ–‡æ¡£åªè½¬æ¢äº†ä¸€å°éƒ¨åˆ†å†…å®¹ã€‚

**æŠ€æœ¯æ ¹å› ï¼š**
åœ¨ `src/kb_agent/connectors/local_file.py` ä¸­ï¼Œ`_read_docx` çš„å®žçŽ°æžå…¶ç®€é™‹ï¼š
```python
def _read_docx(self, file_path: Path) -> str:
    doc = Document(file_path)
    full_text = []
    for para in doc.paragraphs:  # <--- ç½ªé­ç¥¸é¦–
        full_text.append(para.text)
    return "\n\n".join(full_text)
```
- **ä¸¢å¤±è¡¨æ ¼ (Tables):** `doc.paragraphs` ä»…åŒ…å«é¡¶çº§æ®µè½ï¼Œä¸åŒ…å«è¡¨æ ¼å†…çš„å†…å®¹ã€‚å¤§åž‹ Word æ–‡æ¡£é€šå¸¸åŒ…å«å¤§é‡è¡¨æ ¼ï¼Œè¿™äº›å†…å®¹ä¼šå®Œå…¨ä¸¢å¤±ã€‚
- **ä¸¢å¤±æµ®åŠ¨æ¡† (Text Boxes):** æ–‡æœ¬æ¡†å†…çš„æ–‡å­—åŒæ ·ä¸å±žäºŽ `paragraphs`ã€‚
- **ä¸¢å¤±é¡µå¤´/é¡µè„š:** åŒæ ·è¢«å¿½ç•¥ã€‚
- **ä¸¢å¤±å…ƒæ•°æ®:** æ–‡æ¡£å±žæ€§ç­‰ä¿¡æ¯æœªæå–ã€‚

### ðŸ”´ é—®é¢˜ 2: å¤šé‡"æš´åŠ›æˆªæ–­"å¯¼è‡´çš„çŸ¥è¯†æ–­å¸¦
ç³»ç»Ÿåœ¨å¤šä¸ªçŽ¯èŠ‚å­˜åœ¨ç¡¬ç¼–ç çš„æˆªæ–­ï¼Œå¯¼è‡´å¤§æ–‡ä»¶ï¼ˆå³ä½¿è½¬æ¢æˆåŠŸï¼‰ä¹Ÿè¢«åˆ‡æˆç¢Žç‰‡ï¼š

| çŽ¯èŠ‚ | æˆªæ–­ä»£ç /ä½ç½® | å½±å“ |
|------|--------------|------|
| **å…¨æ–‡ç´¢å¼•** | `processor.py:70`: `full_content[:2000]` | ChromaDB åªå­˜äº†æ–‡æ¡£å‰ ~500 å­—ï¼Œå‰©ä¸‹ 98% å†…å®¹æ— æ³•æ£€ç´¢ã€‚ |
| **æ‘˜è¦ç”Ÿæˆ** | `llm.py:42`: `content[:4000]` | æ‘˜è¦åªæè¿°äº†æ–‡æ¡£çš„"å‰è¨€"ï¼Œå®Œå…¨å¿½ç•¥äº†æ­£æ–‡å’Œç»“è®ºã€‚ |

### ðŸ”´ é—®é¢˜ 3: Summary â†” Full Content å…³ç³»æ–­è£‚
è™½ç„¶ ChromaDB å­˜å‚¨äº† summary å’Œ full contentï¼Œä½†æ£€ç´¢é€»è¾‘ï¼ˆAgent/RAGï¼‰å¹¶æ²¡æœ‰åˆ©ç”¨å®ƒä»¬çš„å…³ç³»ã€‚
- æœåˆ° Summary æ—¶ï¼Œç³»ç»Ÿä¸çŸ¥é“æ€Žä¹ˆæŠŠç›¸å…³çš„ Full Content ä¸€å¹¶æ‹‰å‡ºæ¥ã€‚
- è¿™ç§"ä¸¤å¼ çš®"çš„å­˜å‚¨æ–¹å¼å¯¼è‡´ LLM æ— æ³•åœ¨å…·å¤‡å…¨å±€è§†é‡Žçš„åŒæ—¶æŸ¥çœ‹ç»†èŠ‚ã€‚

### ðŸ”´ é—®é¢˜ 4: åŸºç¡€èƒ½åŠ›ç¼ºå¤± (PDF & Excel)
- **PDF é›¶æ”¯æŒ:** ç›´æŽ¥å¿½ç•¥ PDF æ–‡ä»¶ï¼Œè¿™æ˜¯ç›®å‰ä¼ä¸šçŸ¥è¯†åº“æœ€æ ¸å¿ƒçš„æ ¼å¼ã€‚
- **Excel è¿‡äºŽå¤©çœŸ:** åªè¯»ç¬¬ä¸€ä¸ª Sheetï¼Œä¸”æœªå¯¹è¡Œæ•°åšåˆ†æ®µå¤„ç†ã€‚5MB çš„ Excel è½¬æˆ Markdown Table ä¼šäº§ç”Ÿå·¨å¤§çš„å­—ç¬¦ä¸²ï¼Œç›´æŽ¥è¶…å‡ºæ‰€æœ‰å¤„ç†é™åˆ¶ã€‚

### ðŸ”´ é—®é¢˜ 5: ç¼ºä¹åˆ†å‰² (Chunking) æœºåˆ¶
å‘é‡æ•°æ®åº“çš„å¨åŠ›åœ¨äºŽæŸ¥å‡†ã€‚å½“å‰ç³»ç»Ÿä¸åˆ†æ®µï¼Œæ„å‘³ç€æ£€ç´¢å•ä½æ˜¯"æ•´ä¸ªï¼ˆæˆªæ–­çš„ï¼‰æ–‡æ¡£"ã€‚
- **å¬å›žçŽ‡ä½Ž:** æ•´ä¸ªæ–‡æ¡£çš„ Embedding ä¼šæ¨¡ç³Šç»†èŠ‚ã€‚
- **æ— ä¸Šä¸‹æ–‡:** æ— æ³•è¿”å›žåŒ¹é…ä½ç½®çš„å‰åŽæ–‡ã€‚

---

## 2. æ”¹è¿›æ–¹æ¡ˆå»ºè®®

### A. ä¿®å¤ Word æå– (DOCX Recovery)
å»ºè®®æ”¹ç”¨ `iter_inner_content` æ¨¡å¼ï¼Œå¹¶é€’å½’å¤„ç†è¡¨æ ¼ã€‚å•çº¯çš„ `paragraphs` éåŽ†ä¼šè·³è¿‡æ–‡æ¡£ä¸­è‡³å°‘ 40% çš„ç»“æž„åŒ–å†…å®¹ã€‚

### B. å¼•å…¥åˆ†æ®µæ‘˜è¦ (Map-Reduce Summary)
é’ˆå¯¹å¤§æ–‡ä»¶ï¼Œä¸å†ç›´æŽ¥æˆªæ–­ï¼Œè€Œæ˜¯ï¼š
1. **Split:** å°†é•¿æ–‡åˆ†æˆ 4k å­—ç¬¦çš„æ®µè½ã€‚
2. **Map:** ç”Ÿæˆæ¯æ®µçš„æ‘˜è¦ã€‚
3. **Reduce:** å°†æ®µè½æ‘˜è¦æ±‡æ€»ç”Ÿæˆå…¨å±€æ‘˜è¦ã€‚

### C. å‘é‡åŒ–ç­–ç•¥å‡çº§ (Semantic Splitter)
æŽ¨èå¼•å…¥ `RecursiveCharacterTextSplitter`:
- **Chunk Size:** 1000 tokens
- **Overlap:** 200 tokens (ç¡®ä¿è¯­ä¹‰è¿žç»­ä¸è¢«åˆ‡æ–­)
- **Metadata:** å¼ºåˆ¶å­˜å‚¨ `parent_doc_id` å’Œ `chunk_index`ã€‚

---

## 3. ä¼˜å…ˆçº§è·¯çº¿å›¾

| ä¼˜å…ˆçº§ | ä»»åŠ¡ | ç›®æ ‡ |
|:---:|:---:|---|
| **P0** | **DOCX/Excel å®Œæ•´æ€§ä¿®å¤** | ç¡®ä¿ 5MB æ–‡æ¡£è¿›å¾—åŽ»ï¼Œè½¬å¾—å…¨ã€‚ |
| **P0** | **ç§»é™¤ç¡¬ç¼–ç æˆªæ–­ + Chunking** | åºŸå¼ƒ `[:2000]`ï¼Œæ”¹ä¸ºå…¨é‡åˆ†æ®µç´¢å¼•ã€‚ |
| **P1** | **PDF è§£æžæ”¯æŒ** | å¼•å…¥ `PyMuPDF` è§£æžèƒ½åŠ›ã€‚ |
| **P1** | **Map-Reduce Summary** | è§£å†³å¤§æ–‡ä»¶"åªè§æ ‘æœ¨ä¸è§æ£®æž—"çš„æ‘˜è¦é—®é¢˜ã€‚ |
| **P2** | **å±‚çº§æ£€ç´¢ (Parent Retriever)** | æœç´¢ Summary è”åŠ¨åŽŸå§‹ Chunk çš„é«˜çº§æ£€ç´¢èƒ½åŠ›ã€‚ |

---

## 4. è¡ŒåŠ¨å»ºè®® (Next Steps)

1. **æ›´æ–° Spec:** å°† indexing-pipeline çš„è¦æ±‚ä»Ž "Truncated" æ”¹ä¸º "Chunked"ã€‚
2. **é‡æž„ Connector:** å‡çº§ DOCX å’Œ Excel çš„è¯»å–é€»è¾‘ã€‚
3. **å¼•å…¥ Splitter:** åœ¨ `Processor` å±‚åŠ å…¥åˆ†æ®µå™¨ã€‚

---
*æŠ¥å‘Šç”Ÿæˆï¼šAntigravity Agent*
*æœ€åŽæ›´æ–°ï¼š2026-03-01*
